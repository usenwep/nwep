name: Build

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  linux:
    name: Linux (${{ matrix.arch }}, ${{ matrix.compiler }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            arch: x86_64
            compiler: gcc
            cc: gcc
            cxx: g++

          - runner: ubuntu-24.04
            arch: x86_64
            compiler: clang
            cc: clang
            cxx: clang++

          - runner: ubuntu-24.04-arm
            arch: aarch64
            compiler: gcc
            cc: gcc
            cxx: g++

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: deps-linux-${{ matrix.arch }}-${{ hashFiles('build.sh', 'third_party/quictls', 'third_party/ngtcp2', 'third_party/blst') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libuv1-dev

      - name: Build all
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: ./build.sh

      - name: Run C tests
        run: cd build && ctest --output-on-failure

      - name: Run Node.js tests
        run: node node/test/basic.test.js

      - name: Package
        run: ./build.sh package

      - uses: actions/upload-artifact@v4
        with:
          name: nwep-linux-${{ matrix.arch }}-${{ matrix.compiler }}
          path: dist/*.tar.gz

  macos:
    name: macOS (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x86_64

          - runner: macos-14
            arch: aarch64

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: deps-darwin-${{ matrix.arch }}-${{ hashFiles('build.sh', 'third_party/quictls', 'third_party/ngtcp2', 'third_party/blst') }}

      - name: Install dependencies
        run: brew install libuv

      - name: Build all
        run: ./build.sh

      - name: Run C tests
        run: cd build && ctest --output-on-failure

      - name: Run Node.js tests
        run: node node/test/basic.test.js

      - name: Package
        run: ./build.sh package

      - uses: actions/upload-artifact@v4
        with:
          name: nwep-darwin-${{ matrix.arch }}
          path: dist/*.tar.gz

  mingw-cross:
    name: MinGW Cross-Compile (${{ matrix.arch }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            host: x86_64-w64-mingw32
            packages: gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64

          - arch: x86
            host: i686-w64-mingw32
            packages: gcc-mingw-w64-i686 g++-mingw-w64-i686

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: deps-mingw-${{ matrix.arch }}-${{ hashFiles('build.sh', 'third_party/quictls', 'third_party/ngtcp2', 'third_party/blst') }}

      - name: Install MinGW toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ${{ matrix.packages }}

      - name: Build and package
        env:
          HOST: ${{ matrix.host }}
        run: ./build.sh --package

      - name: Verify build
        run: |
          file .build/*/nwep/libnwep.a || file build/libnwep.a
          ls dist/*.zip

      - uses: actions/upload-artifact@v4
        with:
          name: nwep-mingw-${{ matrix.arch }}
          path: dist/*.zip

  arm-cross:
    name: ARM Cross-Compile (${{ matrix.arch }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: armhf
            host: arm-linux-gnueabihf
            packages: gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf

          - arch: aarch64
            host: aarch64-linux-gnu
            packages: gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .build
          key: deps-arm-${{ matrix.arch }}-${{ hashFiles('build.sh', 'third_party/quictls', 'third_party/ngtcp2', 'third_party/blst') }}

      - name: Install ARM toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ${{ matrix.packages }}

      - name: Build and package
        env:
          HOST: ${{ matrix.host }}
        run: ./build.sh --package

      - name: Verify build
        run: |
          file .build/*/nwep/libnwep.a || file build/libnwep.a
          ls dist/*.tar.gz

      - uses: actions/upload-artifact@v4
        with:
          name: nwep-linux-${{ matrix.arch }}-cross
          path: dist/*.tar.gz

  windows-msvc:
    name: Windows (MSVC, x64)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install NASM
        uses: ilammy/setup-nasm@v1

      - name: Install Strawberry Perl
        run: choco install strawberryperl --no-progress

      - name: Build quictls
        shell: cmd
        run: |
          mkdir third_party\quictls-build
          cd third_party\quictls-build
          perl ..\quictls\Configure ^
            --prefix=%GITHUB_WORKSPACE%\third_party\quictls-install ^
            --openssldir=%GITHUB_WORKSPACE%\third_party\quictls-install ^
            no-shared no-tests enable-tls1_3 ^
            VC-WIN64A
          nmake
          nmake install_sw

      - name: Build ngtcp2
        shell: cmd
        run: |
          mkdir third_party\ngtcp2-build
          cd third_party\ngtcp2-build
          cmake ..\ngtcp2 ^
            -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DENABLE_SHARED_LIB=OFF ^
            -DENABLE_STATIC_LIB=ON ^
            -DENABLE_OPENSSL=ON ^
            -DENABLE_GNUTLS=OFF ^
            -DENABLE_BORINGSSL=OFF ^
            -DENABLE_PICOTLS=OFF ^
            -DENABLE_WOLFSSL=OFF ^
            -DOPENSSL_ROOT_DIR=%GITHUB_WORKSPACE%\third_party\quictls-install ^
            -DBUILD_TESTING=OFF
          cmake --build . --config Release

      - name: Build blst
        shell: cmd
        run: |
          cd third_party\blst
          call build.bat

      - name: Build nwep
        shell: cmd
        run: |
          mkdir build
          cd build
          cmake .. ^
            -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DQUICTLS_ROOT=%GITHUB_WORKSPACE%\third_party\quictls-install ^
            -DNGTCP2_BUILD=%GITHUB_WORKSPACE%\third_party\ngtcp2-build ^
            -DNWEP_BUILD_TESTS=OFF
          cmake --build . --config Release

      - name: Verify build
        shell: cmd
        run: |
          dir build\Release\nwep.lib
          if not exist build\Release\nwep.lib exit /b 1

      - name: Build Node.js addon
        shell: cmd
        run: |
          cd node && call npm install --ignore-scripts && cd ..
          call node\node_modules\.bin\cmake-js build ^
            --out .build\node ^
            --CDNWEP_BUILD_TESTS=OFF ^
            --CDQUICTLS_ROOT=%GITHUB_WORKSPACE%\third_party\quictls-install ^
            --CDNGTCP2_BUILD=%GITHUB_WORKSPACE%\third_party\ngtcp2-build ^
            --CDBLST_ROOT=%GITHUB_WORKSPACE%\third_party\blst

      - name: Run Node.js tests
        run: node node/test/basic.test.js

      - name: Package
        shell: pwsh
        run: |
          $version = (Get-Content VERSION).Trim()
          $pkg = "nwep-$version-windows-x86_64"
          $staging = "dist\$pkg"

          # Create directory structure
          New-Item -ItemType Directory -Force -Path "$staging\lib", "$staging\include\nwep", "$staging\include\ngtcp2", "$staging\include\openssl"

          # Libraries
          Copy-Item "build\Release\nwep.lib" "$staging\lib\"

          # ngtcp2 - try both naming conventions
          $ngtcp2Candidates = @(
            "third_party\ngtcp2-build\lib\Release\ngtcp2_static.lib",
            "third_party\ngtcp2-build\lib\Release\ngtcp2.lib"
          )
          foreach ($c in $ngtcp2Candidates) {
            if (Test-Path $c) { Copy-Item $c "$staging\lib\ngtcp2.lib"; break }
          }

          $cryptoCandidates = @(
            "third_party\ngtcp2-build\crypto\quictls\Release\ngtcp2_crypto_quictls_static.lib",
            "third_party\ngtcp2-build\crypto\quictls\Release\ngtcp2_crypto_quictls.lib"
          )
          foreach ($c in $cryptoCandidates) {
            if (Test-Path $c) { Copy-Item $c "$staging\lib\ngtcp2_crypto_quictls.lib"; break }
          }

          Copy-Item "third_party\quictls-install\lib\libssl.lib" "$staging\lib\"
          Copy-Item "third_party\quictls-install\lib\libcrypto.lib" "$staging\lib\"
          Copy-Item "third_party\blst\blst.lib" "$staging\lib\"

          # Fat archive via lib.exe
          $libs = Get-ChildItem "$staging\lib\*.lib" | ForEach-Object { $_.FullName }
          lib.exe /OUT:"$staging\lib\nwep_packed.lib" @libs

          # Headers
          Copy-Item "include\nwep\nwep.h" "$staging\include\nwep\"
          Copy-Item "build\include\nwep\version.h" "$staging\include\nwep\"
          Copy-Item "third_party\quictls-install\include\openssl\*.h" "$staging\include\openssl\"
          Copy-Item "third_party\ngtcp2\lib\includes\ngtcp2\ngtcp2.h" "$staging\include\ngtcp2\"
          Copy-Item "third_party\ngtcp2-build\lib\includes\ngtcp2\version.h" "$staging\include\ngtcp2\"
          Copy-Item "third_party\ngtcp2\crypto\includes\ngtcp2\ngtcp2_crypto.h" "$staging\include\ngtcp2\"
          Copy-Item "third_party\ngtcp2\crypto\includes\ngtcp2\ngtcp2_crypto_quictls.h" "$staging\include\ngtcp2\"
          Copy-Item "third_party\blst\bindings\blst.h" "$staging\include\"

          if (Test-Path "LICENSE") { Copy-Item "LICENSE" "$staging\" }

          # Node.js addon
          if (Test-Path ".build\node\Release\nwep_napi.node") {
            New-Item -ItemType Directory -Force -Path "$staging\nodejs"
            Copy-Item ".build\node\Release\nwep_napi.node" "$staging\nodejs\"
            Write-Host "Including Node.js addon"
          }

          # Create zip
          Compress-Archive -Path "$staging" -DestinationPath "dist\$pkg.zip"
          Write-Host "Package created: dist\$pkg.zip"

      - uses: actions/upload-artifact@v4
        with:
          name: nwep-windows-x86_64
          path: dist/*.zip

  clean-build:
    name: Clean Build Test
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libuv1-dev

      - name: Clean build from scratch
        run: ./build.sh

      - name: Run tests
        run: cd build && ctest --output-on-failure

      - name: Verify library output
        run: |
          test -f build/libnwep.a
          echo "Library built successfully"

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [linux, macos, mingw-cross, arm-cross, windows-msvc]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4

      - name: Aggregate checksums
        run: cat **/SHA256SUMS > SHA256SUMS 2>/dev/null || true

      - uses: softprops/action-gh-release@v2
        with:
          files: |
            **/*.tar.gz
            **/*.zip
            SHA256SUMS
          generate_release_notes: true
